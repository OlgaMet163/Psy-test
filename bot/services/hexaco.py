from __future__ import annotations

from dataclasses import dataclass
from typing import Dict, List, Sequence


@dataclass(frozen=True)
class Statement:
    id: int
    text: str


@dataclass(frozen=True)
class DomainItem:
    statement_id: int
    inverted: bool = False


@dataclass(frozen=True)
class Band:
    id: str
    label: str
    min_value: float
    max_value: float
    min_inclusive: bool = False
    max_inclusive: bool = True

    def contains(self, value: float) -> bool:
        lower_ok = (
            value >= self.min_value if self.min_inclusive else value > self.min_value
        )
        upper_ok = (
            value <= self.max_value if self.max_inclusive else value < self.max_value
        )
        return lower_ok and upper_ok


@dataclass(frozen=True)
class DomainDefinition:
    id: str
    title: str
    visibility: str  # "public" or "internal"
    items: Sequence[DomainItem]
    interpretations: Dict[str, str]


@dataclass(frozen=True)
class HexacoResult:
    domain_id: str
    title: str
    percent: float
    band_id: str
    band_label: str
    interpretation: str
    visibility: str


STATEMENTS: List[Statement] = [
    Statement(
        1,
        "Как часто вы сразу озвучиваете свои цели и намерения в начале общения?",
    ),
    Statement(
        2,
        "Как часто вы держите при себе свои истинные мотивы, пока не поймёте позицию других?",
    ),
    Statement(
        3,
        "Насколько для вас важно, чтобы установленные правила применяли одинаково ко всем?",
    ),
    Statement(
        4,
        "Насколько вам комфортно использовать «серые зоны» системы и правил для собственной выгоды?",
    ),
    Statement(
        5,
        "Как часто вы мысленно прокручиваете, что может пойти не так, готовясь к важному событию?",
    ),
    Statement(
        6,
        "Если вы подготовили план действий, как часто вам необходимо снова прокручивать его в голове для спокойствия?",
    ),
    Statement(
        7,
        "Насколько сильно на вас влияют эмоциональные подъемы и спады людей, с которыми вы регулярно общаетесь?",
    ),
    Statement(
        8,
        "Насколько просто для вас сохранять сугубо рабочие отношения с коллегами и не включаться эмоционально?",
    ),
    Statement(
        9,
        "Насколько для вас комфортно начинать разговор с незнакомцем, который обладает более высоким статусом?",
    ),
    Statement(
        10,
        "Насколько вы предпочитаете сперва наблюдать, а говорить и проявляться позже в новой компании людей?",
    ),
    Statement(
        11,
        "Как часто в вашем голосе \"слышно\" текущее настроение (энтузиазм, радость, грусть и т.д.)?",
    ),
    Statement(
        12,
        "Как часто вы намеренно снижаете свою эмоциональность и выразительность в общении?",
    ),
    Statement(
        13,
        "Насколько для вас легко сохранять спокойствие, если кто-то медлит или повторяет одно и то же?",
    ),
    Statement(
        14,
        "Когда появляются проблемы и трудности, насколько вероятно, что ваше раздражение будет слышно в голосе?",
    ),
    Statement(
        15,
        "Если человек признал ошибку и исправил её, как быстро вы возвращаете прежнее отношение к нему?",
    ),
    Statement(
        16,
        "Когда человек исправил свою ошибку, как часто вы всё равно остаетесь настороже и принимаете эту ошибку во внимание?",
    ),
    Statement(
        17,
        "Насколько часто вы упорядочиваете дела (планер/список задач/календарь) в повседневной жизни?",
    ),
    Statement(
        18,
        "Как часто вы предпочитаете держать дела и задачи в голове?",
    ),
    Statement(
        19,
        "Приходится ли вам уговаривать себя, чтобы доделать скучную задачу?",
    ),
    Statement(
        20,
        "Как часто вам необходим дедлайн или внешнее давление, чтобы завершить дело?",
    ),
    Statement(
        21,
        "Как часто вы «закапываетесь» в принципы, подробности и логику процесса вместо того, чтобы делать по готовой схеме?",
    ),
    Statement(
        22,
        "Как часто вы предпочитаете готовую пошаговую инструкцию глубокому самостоятельному погружению в процесс?",
    ),
    Statement(
        23,
        "Когда вы одеваетесь, насколько важно для вас, чтобы вещи сочетались по стилю/цвету, а не были исключительно удобными и практичными?",
    ),
    Statement(
        24,
        "Как часто вы замечаете детали вашего окружения вроде красивого заката/ночных огней города/игры света и тени на зданиях?",
    ),
]

BANDS: Sequence[Band] = [
    Band("very_low", "Очень низкий", 0, 13, min_inclusive=True),
    Band("low", "Низкий", 13, 31),
    Band("medium", "Средний", 31, 68),
    Band("high", "Высокий", 68, 87),
    Band("very_high", "Очень высокий", 87, 100),
]


def _interp(public: bool, levels: List[str]) -> Dict[str, str]:
    """Helper to zip band ids with texts."""
    band_ids = [band.id for band in BANDS]
    if len(levels) != len(band_ids):
        raise ValueError("Interpretations count does not match band count.")
    return dict(zip(band_ids, levels, strict=True))


DOMAINS: Sequence[DomainDefinition] = [
    DomainDefinition(
        id="honesty_humility",
        title="Честность-скромность",
        visibility="public",
        items=[
            DomainItem(1),
            DomainItem(2, True),
            DomainItem(3),
            DomainItem(4, True),
        ],
        interpretations=_interp(
            True,
            [
                "Человек склонен ставить личную выгоду выше правил и договорённостей. Может идти на обходные пути или использовать других ради результата. Быстро теряет доверие окружения; риск — репутационные потери и конфликты из-за восприятия манипулятивности.",
                "Самоинтерес заметен, человек торгуется и тщательно защищает свои интересы. Может казаться расчётливым и осторожным, доверие формируется медленно. Риск — люди читают это как закрытость или недоверие; плюс — способность держать фокус на результате и не отдавать рычаги без нужды.",
                "Гибко балансирует открытость и осторожность. Может быть прямым или сдержанным в зависимости от контекста и людей. Обычно сохраняет рабочее доверие, но сигнал, который посылает, может колебаться: кто-то увидит прагматика, кто-то — партнёра.",
                "Ставит честность и равные правила высоко; избегает лишних преимуществ. Вокруг такого человека проще строить устойчивое доверие, он поддерживает прозрачность процессов. Риск — иногда упускает личные выгоды или действует слишком прямолинейно там, где нужна гибкость.",
                "Принципиален и бескорыстен, готов поступиться выгодой ради справедливости. Создаёт безопасную, предсказуемую среду, усиливает доверие команды. Риск — может привлекать тех, кто пользуется его альтруизмом, и сам перегружаться обязательствами.",
            ],
        ),
    ),
    DomainDefinition(
        id="neurotism",
        title="Нейротизм",
        visibility="public",
        items=[
            DomainItem(5),
            DomainItem(6),
            DomainItem(7),
            DomainItem(8, True),
        ],
        interpretations=_interp(
            True,
            [
                "Человек с предельно низким уровнем Невротизма эмоционально устойчивый; он редко испытывает стресс или тревогу даже в сложных ситуациях. Такие индивиды обладают высокой способностью справляться с давлением окружающей среды; они сохраняют спокойствие даже при возникновении проблем. Риск — можно недооценивать угрозы и сигналы тревоги у других.",
                "Человек с низким уровнем Невротизма обычно спокоен, но иногда может испытывать лёгкие колебания настроения или беспокойство в стрессовых ситуациях. Он умеет справляться со своими эмоциями, хотя порой ему требуется время для восстановления после напряжённых моментов. Риск — стресс может накапливаться незаметно.",
                "Человек со средним уровнем Невротизма имеет нормальный уровень эмоциональной стабильности; он может испытывать стресс или тревогу время от времени, но умеет справляться с этими эмоциями благодаря здоровым механизмам копинга (например, занятия спортом или хобби).",
                "Человек с высоким уровнем Невротизма часто испытывает тревогу или негативные эмоции; ему бывает сложно справляться с давлением окружающей среды или стрессовыми ситуациями. Это может приводить к повышенной чувствительности к критике или конфликтам с другими людьми. Риск — хроническое напряжение и эмоциональное выгорание.",
                "Человек с очень высоким уровнем Невротизма постоянно находится под воздействием сильного стресса или тревоги; у него могут возникать проблемы с эмоциональной регуляцией (например, частые перепады настроения). Такие индивиды могут страдать от различных психосоматических заболеваний из-за постоянного напряжения. Риск — выраженные психосоматические реакции и потребность в поддержке.",
            ],
        ),
    ),
    DomainDefinition(
        id="extraversion",
        title="Экстраверсия",
        visibility="public",
        items=[
            DomainItem(9),
            DomainItem(10, True),
            DomainItem(11),
            DomainItem(12, True),
        ],
        interpretations=_interp(
            True,
            [
                "Человек с таким результатом обычно проявляет сильную интровертированность. Он предпочитает проводить время в одиночестве или в узком кругу близких людей. Социальные взаимодействия могут вызывать дискомфорт и усталость. Часто такие люди могут быть глубоко рефлексивными и сосредоточенными на своих внутренних переживаниях. Риск — социальная изоляция и упущенные возможности.",
                "Человек с таким результатом может быть сдержанным и предпочитать небольшие компании, избегая больших собраний и шумных мероприятий. Он может быть дружелюбным, но не стремится к активному общению. В социальных ситуациях он может чувствовать себя неуверенно, но способен поддерживать разговор с близкими людьми. Риск — неуверенность в новых социальных ситуациях и замкнутость.",
                "Человек с таким результатом обладает сбалансированным уровнем экстраверсии. Он может наслаждаться общением и проводить время с другими, но также ценит моменты уединения. Такой человек легко адаптируется к различным социальным ситуациям и может быть как активным участником, так и наблюдателем.",
                "Человек с таким результатом энергичен, общителен и любит находиться в центре внимания. Он активно ищет новые знакомства и получает удовольствие от общения с разными людьми. Такие люди часто обладают хорошими навыками коммуникации и могут вдохновлять окружающих своим оптимизмом. Риск — перегруз общением и нехватка времени на восстановление.",
                "Человек с таким результатом является настоящим центром внимания, его энергия притягивает людей. Он постоянно ищет новые возможности для общения и взаимодействия, часто проявляет лидерские качества. Такие люди могут быть харизматичными и способны вдохновлять других на действия. Риск — доминирование, переоценка сил и эмоциональное выгорание.",
            ],
        ),
    ),
    DomainDefinition(
        id="agreeableness",
        title="Доброжелательность",
        visibility="public",
        items=[
            DomainItem(13),
            DomainItem(14, True),
            DomainItem(15),
            DomainItem(16, True),
        ],
        interpretations=_interp(
            True,
            [
                "Человек с таким результатом может проявлять недоверие к другим, быть критичным и эгоистичным. У него могут возникать трудности в построении доверительных отношений, он склонен к манипуляциям ради достижения своих целей. Часто такие люди могут восприниматься как холодные или безразличные. Риск — закрепить репутацию жёсткого и недоверчивого.",
                "Человек с таким результатом может быть сдержанным в своих проявлениях доброты и поддержки. Он иногда ставит свои интересы выше интересов других, что может приводить к конфликтам в отношениях. Однако он способен на сочувствие, особенно к близким людям. Риск — восприниматься как эгоцентричный.",
                "Человек с таким результатом способен на сочувствие и поддержку, но также может быть критичным или требовательным к окружающим. У него есть баланс между заботой о других и заботой о себе; он понимает важность взаимопомощи, но не всегда готов жертвовать своими интересами.",
                "Человек с таким результатом проявляет доброту, отзывчивость и готовность помочь другим. Он ценит гармонию в отношениях и стремится поддерживать позитивное взаимодействие с окружающими. Такие люди часто становятся опорой для друзей и семьи. Риск — жертвовать собственными интересами ради мира.",
                "Человек исключительно доброжелателен, всегда готов прийти на помощь и поддержать других даже в сложных ситуациях. Его забота о других часто ставится выше собственных интересов; он может жертвовать своим временем ради благополучия окружающих. Риск — выгорание и то, что другие будут злоупотреблять его готовностью помогать.",
            ],
        ),
    ),
    DomainDefinition(
        id="conscientiousness",
        title="Добросовестность",
        visibility="public",
        items=[
            DomainItem(17),
            DomainItem(18, True),
            DomainItem(19, True),
            DomainItem(20, True),
        ],
        interpretations=_interp(
            True,
            [
                "Такой человек может быть неряшливым, неорганизованным и склонным к импульсивному поведению. У него возникают трудности с выполнением обязательств; он часто откладывает дела на потом или забывает о них вовсе. Это может приводить к проблемам как в личной жизни, так и на работе. Риск — устойчивые провалы по срокам и качеству.",
                "Такой человек иногда проявляет недостаток организованности и ответственности; он может не всегда следовать планам или завершать начатые дела. Его подход к жизни более спонтанный, что иногда приводит к негативным последствиям. Риск — накапливание незавершённых задач.",
                "Такой человек демонстрирует умеренный уровень ответственности; он способен выполнять обязательства, но иногда может откладывать дела на потом или терять фокус на задачах. Он умеет планировать свои действия, но не всегда придерживается намеченного плана.",
                "Такой человек очень ответственный, организованный и целеустремлённый; он тщательно планирует свои действия и стремится достигать поставленных целей. Такие люди также обычно надёжны в работе и личной жизни; их можно считать образцом добросовестности. Риск — излишняя требовательность к себе и другим, возможна перегрузка.",
                "Такой человек является образцом добросовестности; он всегда выполняет свои обязательства на высоком уровне и обращает внимание на детали во всём, что делает. Его организованность вдохновляет окружающих; такие люди часто занимают руководящие позиции благодаря своей надёжности. Риск — перфекционизм и повышенная уязвимость к выгоранию.",
            ],
        ),
    ),
    DomainDefinition(
        id="openness",
        title="Открытость опыту",
        visibility="public",
        items=[
            DomainItem(21),
            DomainItem(22, True),
            DomainItem(23),
            DomainItem(24),
        ],
        interpretations=_interp(
            True,
            [
                "Человек с таким показателем Открытости опыту предпочитает рутину и традиционные подходы; он не склонен к экспериментам или новым идеям, часто избегает изменений в своей жизни (например, новых хобби или путешествий). Такие люди могут быть консервативными в своих взглядах на жизнь. Риск — упустить инновации и возможности роста.",
                "Человек с таким показателем Открытости опыту может быть консервативным в своих взглядах; он не всегда открыт для новых идей или опыта, предпочитая знакомое окружение и привычные занятия. Это может ограничивать его возможности для роста и развития. Риск — сложнее адаптироваться к переменам.",
                "Человек с таким показателем Открытости опыту демонстрирует умеренную открытость; он готов рассмотреть новые идеи или опыт при условии их разумности и безопасности для себя. Такой человек ценит традиции, но также понимает важность изменений для личностного роста.",
                "Человек с таким показателем Открытости опыту любознателен, открыт для новых идей и опытов; он стремится исследовать мир вокруг себя через различные виды деятельности (например, путешествия или изучение новых культур). Такие индивиды часто имеют широкий круг интересов. Риск — переключение внимания может замедлять завершение дел.",
                "Человек с таким показателем Открытости опыту является истинным искателем приключений; он активно ищет новые впечатления, идеи и возможности для самовыражения через творчество (например, искусство) или необычные хобби (например, экстремальные виды спорта). Его оригинальность выделяет его среди других людей. Риск — импульсивные решения, частые смены фокуса или повышенная тяга к риску.",
            ],
        ),
    ),
]


class HexacoEngine:
    """Расчёт баллов и интерпретаций HEXACO (two-facet)."""

    answer_range = (1, 2, 3, 4, 5)

    def __init__(self, domains: Sequence[DomainDefinition] | None = None) -> None:
        self.domains = domains or DOMAINS
        self.statements = STATEMENTS

    def total_questions(self) -> int:
        return len(self.statements)

    def get_statement(self, index: int) -> Statement:
        return self.statements[index]

    def calculate(self, answers: Dict[int, int]) -> List[HexacoResult]:
        self._validate_answers(answers)
        results: List[HexacoResult] = []
        for domain in self.domains:
            percent = self._calculate_percent(domain, answers)
            band = self._resolve_band(percent)
            interpretation = domain.interpretations.get(band.id, "")
            results.append(
                HexacoResult(
                    domain_id=domain.id,
                    title=domain.title,
                    percent=percent,
                    band_id=band.id,
                    band_label=band.label,
                    interpretation=interpretation,
                    visibility=domain.visibility,
                )
            )
        return results

    def _validate_answers(self, answers: Dict[int, int]) -> None:
        missing = {item.id for item in self.statements} - set(answers.keys())
        if missing:
            raise ValueError(f"Missing answers for questions: {sorted(missing)}")
        invalid = [
            (statement_id, value)
            for statement_id, value in answers.items()
            if value not in self.answer_range
        ]
        if invalid:
            raise ValueError(f"Invalid answer values: {invalid}")

    def _calculate_percent(
        self, domain: DomainDefinition, answers: Dict[int, int]
    ) -> float:
        total = 0
        for item in domain.items:
            value = answers[item.statement_id]
            total += self._transform_value(value, item.inverted)
        n = len(domain.items)
        # Нормализация: ((S - N) / (4N)) * 100
        percent = ((total - n) / (4 * n)) * 100
        return max(0.0, min(100.0, round(percent, 2)))

    @staticmethod
    def _transform_value(value: int, inverted: bool) -> int:
        return 6 - value if inverted else value

    def _resolve_band(self, percent: float) -> Band:
        for band in BANDS:
            if band.contains(percent):
                return band
        return Band("unknown", "Неизвестно", 0, 100, True, True)
