# flake8: noqa: E501
from __future__ import annotations

from dataclasses import dataclass
from typing import Dict, List, Sequence


@dataclass(frozen=True)
class SvsStatement:
    id: int
    text: str
    value_id: str


@dataclass(frozen=True)
class Band:
    id: str
    label: str
    min_value: float
    max_value: float
    min_inclusive: bool = False
    max_inclusive: bool = True

    def contains(self, value: float) -> bool:
        lower_ok = (
            value >= self.min_value if self.min_inclusive else value > self.min_value
        )
        upper_ok = (
            value <= self.max_value if self.max_inclusive else value < self.max_value
        )
        return lower_ok and upper_ok


@dataclass(frozen=True)
class ValueDefinition:
    id: str
    title: str
    group_id: str
    statements: Sequence[int]
    interpretations: Dict[str, str]
    visibility: str = "public"


@dataclass(frozen=True)
class GroupDefinition:
    id: str
    title: str
    value_ids: Sequence[str]
    interpretations: Dict[str, str]
    visibility: str = "public"


@dataclass(frozen=True)
class SvsResult:
    domain_id: str
    title: str
    mean_score: float
    percent: float
    band_id: str
    band_label: str
    interpretation: str
    visibility: str
    category: str  # "value" или "group"


STATEMENTS: Sequence[SvsStatement] = [
    SvsStatement(
        1,
        "Если инструкции кажутся вам нелогичными, вы предлагаете вариант получше.",
        "SD",
    ),
    SvsStatement(
        2, "Вам нравится учиться самостоятельно, без внешних дедлайнов.", "SD"
    ),
    SvsStatement(
        3,
        "Изменения (новые проекты/обстановка) скорее заряжают вас, чем выматывают.",
        "ST",
    ),
    SvsStatement(4, "Вы любите занятия, связанные с риском или вызовом.", "ST"),
    SvsStatement(
        5, "Вы намеренно добавляете маленькие «радости» в повседневную жизнь.", "HE"
    ),
    SvsStatement(6, "«<i>Это будет приятно</i>» сильно влияет на ваше решение.", "HE"),
    SvsStatement(
        7,
        "Ваша мотивация довольно сильно зависит от внешней обратной связи.",
        "AC",
    ),
    SvsStatement(8, "В будущем году вам важно прокачать навыки и достижения.", "AC"),
    SvsStatement(
        9,
        "Вы склонны определять приоритеты команды, даже если на это не было запроса.",
        "PO",
    ),
    SvsStatement(
        10,
        "Вам комфортно добиваться своего в переговорах, даже если это создаёт напряжение.",
        "PO",
    ),
    SvsStatement(
        11, "Запасные планы и альтернативы помогают вам сохранять спокойствие.", "SEC"
    ),
    SvsStatement(
        12,
        "Вы избегаете ситуаций, которые могут привести к хаосу или ущербу.",
        "SEC",
    ),
    SvsStatement(
        13, "Вам важно делать всё по установленным правилам и договорённостям.", "CO"
    ),
    SvsStatement(
        14, "Вы часто сглаживаете углы, чтобы удерживать хорошие отношения.", "CO"
    ),
    SvsStatement(
        15,
        "У вас много ритуалов (привычных действий), которые вы не готовы менять.",
        "TR",
    ),
    SvsStatement(
        16,
        "«<i>Мы всегда делали так</i>» кажется вам лучшим решением, чем новый неопробованный подход.",
        "TR",
    ),
    SvsStatement(17, "Люди привыкли полагаться на вас.", "BE"),
    SvsStatement(
        18,
        "Когда близкий человек в стрессе, вы быстро переключаетесь в режим поддержки.",
        "BE",
    ),
    SvsStatement(
        19,
        "Вы часто заранее просчитываете вторичные последствия для команды или процесса.",
        "UN",
    ),
    SvsStatement(
        20,
        "Этика ощутимо влияет на выбор организаций, с которыми вы работаете.",
        "UN",
    ),
]

BANDS: Sequence[Band] = [
    Band("very_low", "Очень низкий", 0, 13, min_inclusive=True),
    Band("low", "Низкий", 13, 31),
    Band("medium", "Средний", 31, 68),
    Band("high", "Высокий", 68, 87),
    Band("very_high", "Очень высокий", 87, 100),
]


def _interp(levels: Sequence[str]) -> Dict[str, str]:
    band_ids = [band.id for band in BANDS]
    if len(levels) != len(band_ids):
        raise ValueError("Interpretations must match number of bands.")
    return dict(zip(band_ids, levels, strict=True))


VALUE_DEFINITIONS: Sequence[ValueDefinition] = [
    ValueDefinition(
        id="SD",
        title="Самостоятельность",
        group_id="openness_change",
        statements=[1, 2],
        interpretations=_interp(
            [
                "Вы опираетесь на внешние инструкции и реже продвигаете свои идеи. Чаще выбираете проверенные схемы и запрос наставника. Риск: зависимость от чужих решений и упущенные возможности для инициативы.",
                "Обычно следуете указаниям и осторожно добавляете свои предложения. Риск: недоиспользуете автономию и собственные подходы.",
                "Гибко сочетаете руководство и самостоятельность: можете работать по плану и предлагать свои улучшения.",
                "Вы предпочитаете автономно ставить цели и быстро перестраиваете план под новые вводные. Уверенно опираетесь на собственные решения. Риск: игнорирование мнений коллег и несоблюдение договорённостей.",
                "Вы сильно цените личную свободу и сами инициируете изменения. Часто ставите личные цели выше общих процедур. Риск: сопротивление внешнему контролю и конфликты ожиданий с командой.",
            ]
        ),
    ),
    ValueDefinition(
        id="ST",
        title="Стимуляция",
        group_id="openness_change",
        statements=[3, 4],
        interpretations=_interp(
            [
                "Вы ощущаете комфорт в стабильности; новизна и быстрые перемены выматывают. Предпочитаете рутину и заранее понятные сценарии. Риск: долгая адаптация и потеря мотивации при частых сменах задач.",
                "Предпочитаете предсказуемость, но готовы к изменениям, если они дозированы. Риск: сложнее переключаться при резких внешних изменениях.",
                "Открыты к переменам, когда понимаете их пользу. Обычно сохраняете работоспособность в новых условиях.",
                "Регулярно ищете разнообразие и вызовы, новизна вас заряжает. Любите пробовать новое ради энергии. Риск: переизбыток проектов и неполное завершение задач.",
                "Активно стремитесь к новому и риску ради энергии и развития. Получаете энергию от перемен и движетесь быстро. Риск: импульсивные решения и усталость команды от частых поворотов.",
            ]
        ),
    ),
    ValueDefinition(
        id="HE",
        title="Гедонизм",
        group_id="openness_change",
        statements=[5, 6],
        interpretations=_interp(
            [
                "Вы ставите пользу и долг выше удовольствия. Легко жертвуете отдыхом ради дела. Риск: сниженный ресурс восстановления и мало позитивных подкреплений.",
                "Удовольствие вторично, иногда упускаете время на отдых. Риск: накопление усталости и снижение мотивации.",
                "Балансируете удовольствие и практичность; добавляете приятное, когда есть ресурс.",
                "Осознанно вводите «маленькие радости» в быт, чтобы поддерживать тонус. Цените качественный отдых. Риск: можете переоценить краткосрочный комфорт.",
                "Решения сильно ведёт удовольствие и ощущение «это приятно». Часто выбираете комфортные опции. Риск: долгосрочные цели и бюджет могут страдать из-за импульсивных выборов.",
            ]
        ),
    ),
    ValueDefinition(
        id="AC",
        title="Достижение",
        group_id="self_enhancement",
        statements=[7, 8],
        interpretations=_interp(
            [
                "Вы мало опираетесь на внешнюю оценку и редко ставите цели роста. Довольны текущим уровнем. Риск: застой и недооценённые достижения.",
                "Ставите умеренные цели, обратная связь влияет умеренно. Предпочитаете стабильный темп. Риск: упускаете возможности развития или повышения.",
                "Стабильно развиваетесь и учитываете обратную связь, сохраняя баланс нагрузки.",
                "Рост-мышление и фидбек заметно повышают вашу мотивацию. Активно ищете возможности улучшений. Риск: завышенные стандарты и перегруз.",
                "Сильный драйв к статусу и навыкам, фидбек — ключевой стимул. Стремитесь к быстрому росту и признанию. Риск: выгорание и конкуренция с командой вместо кооперации.",
            ]
        ),
    ),
    ValueDefinition(
        id="PO",
        title="Власть",
        group_id="self_enhancement",
        statements=[9, 10],
        interpretations=_interp(
            [
                "Вы избегаете ролей влияния и предпочитаете гармонию. Скорее соглашаетесь, чем ведёте. Риск: ваши интересы могут не учесть, если вы не озвучите их.",
                "Берёте инициативу выборочно и стараетесь минимизировать трения. Предпочитаете мягкие форматы влияния. Риск: при дефиците влияния сложнее продвигать важные решения.",
                "Готовы вести при необходимости и обычно держите баланс между влиянием и сотрудничеством.",
                "Комфортно ведёте переговоры и задаёте направление. Умеете продавливать решения. Риск: при жёстком торге растёт напряжение с коллегами.",
                "Стремитесь к лидерству и активно продвигаете свои решения. Можете давить ради цели. Риск: возможны трения и снижение доверия при доминирующем стиле.",
            ]
        ),
    ),
    ValueDefinition(
        id="SEC",
        title="Безопасность",
        group_id="conservation",
        statements=[11, 12],
        interpretations=_interp(
            [
                "Вам комфортна неопределённость, вы редко готовите запасные варианты. Легко идёте в новые условия без страховки. Риск: недооценка уязвимостей и неожиданные сбои.",
                "Вы умеренно осторожны, но терпимы к риску. Можете ограничиваться минимальными подготовками. Риск: запасные планы могут быть поверхностными.",
                "Балансируете продумывание сценариев и гибкость; обычно держите ситуации под контролем.",
                "Заранее продумываете риски и цените стабильность. Регулярно держите под рукой резервные сценарии. Риск: высокая осторожность может замедлять старт проектов.",
                "Сильный фокус на безопасности и запасных вариантах. Постоянно держите планы B и C. Риск: избегаете возможностей из-за неопределённости, растёт тревожность команды.",
            ]
        ),
    ),
    ValueDefinition(
        id="CO",
        title="Конформность",
        group_id="conservation",
        statements=[13, 14],
        interpretations=_interp(
            [
                "Вы склонны оспаривать правила и ставите прямоту выше гармонии. Говорите в лоб, даже если это задевает. Риск: частые конфликты и потеря доверия.",
                "Следуете правилам выборочно и говорите прямо при необходимости. Можете резко менять тон. Риск: непредсказуемость для окружающих.",
                "Гибко адаптируетесь к правилам, сохраняя возможность говорить открыто.",
                "Предпочитаете ясные нормы и ровный тон общения. Стараетесь держать баланс между прямотой и миром. Риск: сглаживая углы, можете копить недосказанность.",
                "Сильно ориентированы на правила и уважение к нормам. Ставите порядок выше личных предпочтений. Риск: подавляете прямоту и избегаете конфликтов даже когда нужно прояснить позицию.",
            ]
        ),
    ),
    ValueDefinition(
        id="TR",
        title="Традиция",
        group_id="conservation",
        statements=[15, 16],
        interpretations=_interp(
            [
                "Вы слабо привязаны к ритуалам и цените новизну. Легко отпускаете старые форматы. Риск: окружающим может не хватать постоянства.",
                "Готовы менять большинство привычек, оставляя минимум традиций. Быстро обновляете подходы. Риск: другим сложно опираться на устойчивые форматы.",
                "Удерживаете часть ритуалов и обновляете практики при необходимости.",
                "Цените преемственность и повторяющиеся форматы. Любите стабильные циклы. Риск: сопротивление изменениям может замедлять улучшения.",
                "Глубоко опираетесь на традиции и проверенные подходы. Держитесь знакомых практик и склонны отклонять нововведения. Риск: блокируете нововведения и входите в конфликт с инновациями.",
            ]
        ),
    ),
    ValueDefinition(
        id="BE",
        title="Благожелательность",
        group_id="self_transcendence",
        statements=[17, 18],
        interpretations=_interp(
            [
                "Вы редко становитесь опорой для других и держите дистанцию. Редко вовлекаетесь эмоционально. Риск: вас могут считать равнодушным, связи слабеют.",
                "Помогаете по запросу, экономя ресурс. Поддержка точечная. Риск: близкие могут недополучать поддержки.",
                "Поддерживаете, когда можете, и учитываете собственные потребности.",
                "Проактивно включаетесь в помощь близким под давлением. Вас часто просят о поддержке. Риск: перегруз из-за постоянной готовности поддерживать.",
                "Вы очень надёжны для окружения и легко переключаетесь в режим поддержки. Часто становитесь опорой для многих. Риск: выгорание и то, что люди перегружают вас просьбами.",
            ]
        ),
    ),
    ValueDefinition(
        id="UN",
        title="Универсализм",
        group_id="self_transcendence",
        statements=[19, 20],
        interpretations=_interp(
            [
                "Вы сосредоточены на личных целях и редко учитываете системные эффекты. Смотрите на непосредственную пользу для себя и близких. Риск: решения имеют непредвиденные социальные последствия.",
                "Иногда смотрите шире, но приоритет остаётся локальным. Реже отслеживаете общественный эффект. Риск: сложнее предвидеть внешние эффекты и восприятие.",
                "Балансируете личные и общественные результаты; готовы учитывать последствия, если они ясны.",
                "Часто взвешиваете этические и системные эффекты решений. Учитываете интересы разных сторон. Риск: на принятие решения уходит больше времени, когда ценности сталкиваются.",
                "Сильный этический фокус ведёт ваши решения и выбор организаций. Эффект на общество — ключевой критерий. Риск: на принятие решения уходит больше времени, когда ценности сталкиваются.",
            ]
        ),
    ),
]

GROUP_DEFINITIONS: Sequence[GroupDefinition] = [
    GroupDefinition(
        id="openness_change",
        title="Открытость изменениям",
        value_ids=["SD", "ST", "HE"],
        interpretations=_interp(
            [
                "Вы опираетесь на стабильность, внешние планы и избегаете новизны. Стабильность даёт вам чувство контроля. Риск: упущенные возможности из‑за низкой готовности менять курс.",
                "Скорее выбираете стабильность, но допускаете отдельные изменения. Риск: адаптация к быстрым поворотам может замедляться.",
                "Балансируете структуру и исследование нового; меняете подход, если видна польза.",
                "Вас заряжают автономия, новизна и удовольствие. Любите пробовать новые форматы. Риск: переизбыток инициатив, сложнее доводить их до конца.",
                "Очень высокая тяга к изменениям и экспериментам. Движетесь через эксперименты и смену курсов. Риск: частые развороты стратегии и усталость команды от нестабильности.",
            ]
        ),
    ),
    GroupDefinition(
        id="self_enhancement",
        title="Самоутверждение",
        value_ids=["AC", "PO"],
        interpretations=_interp(
            [
                "Умеренная потребность в росте и влиянии, делаете ставку на стабильность. Скорее выбираете надёжность, чем борьбу за статус. Риск: вас могут обходить при распределении ресурсов и ролей.",
                "Рост и влияние важны эпизодически; берёте инициативу выборочно. Риск: ключевые возможности могут уходить к более активным.",
                "Стабильно развиваетесь и влияете, когда это нужно; обычно сохраняете баланс.",
                "Амбициозны и готовы вести, учитывая влияние на результат. Риск: при жёстком продвижении решений растёт сопротивление окружающих.",
                "Сильный мотив статуса и влияния, активное лидерство. Легко берёте лидерство и продвигаете амбициозные цели. Риск: конкуренция с командой, напряжение и риск выгорания.",
            ]
        ),
    ),
    GroupDefinition(
        id="conservation",
        title="Сохранение",
        value_ids=["SEC", "CO", "TR"],
        interpretations=_interp(
            [
                "Вы легко относитесь к переменам, меньше вкладываетесь в безопасность и нормы. Ориентированы на гибкость и быстро меняете курс. Риск: недооценка рисков и потребности других в опоре.",
                "Держите базовые рамки защиты, сохраняя высокую гибкость. Риск: нормы могут восприниматься размытыми.",
                "Балансируете безопасность, правила и адаптацию; гибко обновляете договорённости.",
                "Цените безопасность, порядок и преемственность. Предпочитаете предсказуемый ритм. Риск: осторожность замедляет внедрение изменений.",
                "Сильно ориентированы на сохранение, регламенты и ритуалы. Считаете порядок основой безопасности. Риск: сопротивление изменениям и слабая толерантность к неопределённости.",
            ]
        ),
    ),
    GroupDefinition(
        id="self_transcendence",
        title="Самопреодоление",
        value_ids=["BE", "UN"],
        interpretations=_interp(
            [
                "Фокусируетесь на личных целях и ограниченно учитываете других. Сфокусированы на своём круге задач. Риск: отношения и социальный эффект решений страдает.",
                "Помогаете, когда можете, но широкий эффект вторичен. Основной фокус — свои задачи. Риск: важные социальные аспекты остаются без внимания.",
                "Балансируете личные интересы и заботу о других; учитываете эффект на окружение, если он очевиден.",
                "Регулярно взвешиваете влияние на людей и общественные последствия. Стараетесь учитывать разные стороны. Риск: решения могут замедляться при сложных компромиссах.",
                "Сильная ориентация на сервис и влияние, этика ведёт ваши выборы. Часто ставите благо других в приоритет. Риск: труднее принимать прагматичные компромиссы, выше риск перегруза заботой.",
            ]
        ),
    ),
]


class SvsEngine:
    """Расчёт по Schwartz Value Survey (1–5, 20 items)."""

    answer_range = tuple(range(1, 6))

    def __init__(
        self,
        values: Sequence[ValueDefinition] | None = None,
        groups: Sequence[GroupDefinition] | None = None,
        statements: Sequence[SvsStatement] | None = None,
    ) -> None:
        self.values = values or VALUE_DEFINITIONS
        self.groups = groups or GROUP_DEFINITIONS
        self.statements = statements or STATEMENTS
        self._value_map = {value.id: value for value in self.values}
        self._group_map = {group.id: group for group in self.groups}

    def total_questions(self) -> int:
        return len(self.statements)

    def get_statement(self, index: int) -> SvsStatement:
        return self.statements[index]

    def calculate(self, answers: Dict[int, int]) -> List[SvsResult]:
        self._validate_answers(answers)
        value_results = [self._calculate_value(value, answers) for value in self.values]
        group_results = [
            self._calculate_group(group, value_results) for group in self.groups
        ]
        return value_results + group_results

    def _validate_answers(self, answers: Dict[int, int]) -> None:
        missing = {item.id for item in self.statements} - set(answers.keys())
        if missing:
            raise ValueError(f"Missing answers for questions: {sorted(missing)}")
        invalid = [
            (statement_id, value)
            for statement_id, value in answers.items()
            if value not in self.answer_range
        ]
        if invalid:
            raise ValueError(f"Invalid answer values: {invalid}")

    def _calculate_value(
        self, definition: ValueDefinition, answers: Dict[int, int]
    ) -> SvsResult:
        mean_score = self._mean_for_statements(definition.statements, answers)
        percent = self._mean_to_percent(mean_score)
        band = self._resolve_band(percent)
        interpretation = definition.interpretations.get(band.id, "")
        return SvsResult(
            domain_id=definition.id,
            title=definition.title,
            mean_score=mean_score,
            percent=percent,
            band_id=band.id,
            band_label=band.label,
            interpretation=interpretation,
            visibility=definition.visibility,
            category="value",
        )

    def _calculate_group(
        self, definition: GroupDefinition, value_results: Sequence[SvsResult]
    ) -> SvsResult:
        relevant = [
            res for res in value_results if res.domain_id in definition.value_ids
        ]
        if not relevant:
            raise ValueError(f"Не найдены значения для группы {definition.id}")
        mean_score = round(
            sum(result.mean_score for result in relevant) / len(relevant), 2
        )
        percent = self._mean_to_percent(mean_score)
        band = self._resolve_band(percent)
        interpretation = definition.interpretations.get(band.id, "")
        return SvsResult(
            domain_id=f"group_{definition.id}",
            title=definition.title,
            mean_score=mean_score,
            percent=percent,
            band_id=band.id,
            band_label=band.label,
            interpretation=interpretation,
            visibility=definition.visibility,
            category="group",
        )

    @staticmethod
    def _mean_for_statements(
        statement_ids: Sequence[int], answers: Dict[int, int]
    ) -> float:
        values = [answers[statement_id] for statement_id in statement_ids]
        return round(sum(values) / len(values), 2)

    @staticmethod
    def _mean_to_percent(mean_score: float) -> float:
        return max(0.0, min(100.0, round(((mean_score - 1) / 4) * 100, 2)))

    def _resolve_band(self, percent: float) -> Band:
        for band in BANDS:
            if band.contains(percent):
                return band
        return Band("unknown", "Неизвестно", 0, 100, True, True)
