# Техническая концепция

## Архитектура (черновик)
- Telegram Bot API + вебхуки (предпочтительно) через HTTPS.
- Backend-сервис для логики тестов, расчётов и мэтчинга (Python + FastAPI/Quart).
- Локальная база данных SQLite (`data/bot.db`) для ответов и агрегатов; при необходимости выгружаем CSV.
- Отдельный административный фронт (mini-app или web-dashboard) поверх того же backend API с ролевой моделью доступа.

## Обработка тестов
- Каждое тестирование хранит:
  - метаданные шкал и вопросов;
  - формулы подсчёта;
  - шаблоны интерпретаций.
- Алгоритмы подсчёта и мэтчинга оформляем в виде модулей/агентов с единым интерфейсом.
- Состояние прохождения теста (последний заданный вопрос и ответы) кешируем, чтобы позволить пользователю поставить паузу.

## Модуль расчёта HEXACO и тёмной триады
- Храним конфигурацию доменов (`docs/tests/hexaco subtle.md`) в виде структуры: `domain_id`, список утверждений, признак инверсии, диапазон видимости (user/admin).
- После каждого ответа выполняем инкрементальный пересчёт: собираем значения по домену, применяем инверсию, считаем процент по формуле `((S − N) / (4N)) * 100`.
- На завершении теста фиксируем итоговые проценты, присваиваем интервал (очень низкий → очень высокий) и выбираем текст интерпретации по домену.
- В SQLite поддерживаем две таблицы с агрегатами: `hexaco_answers` (сырые ответы) и `hexaco_results` (проценты по всем девяти доменам) с отметкой видимости.
- REST/GraphQL слой возвращает пользователю только публичные шкалы, а админскому интерфейсу — полный набор с отметкой «internal_only».

## Админская зона
- Авторизация только по отдельным учётным записям/SSO; токены из Телеграма не подходят.
- Админ видит:
  - реестр пользователей и прогресс по каждому тесту;
  - сырые ответы и расширенные рассчитанные показатели;
  - историю изменений интерпретаций/комментариев.
- Все действия логируются (кто что смотрел/выгружал).

## Хранение и выгрузка
- Все ответы и результаты сохраняются локально в SQLite (`data/bot.db`), что упрощает развертывание без внешних сервисов.
- Для административной выгрузки используем скрипт `python scripts/export_hexaco.py --output exports`, который формирует CSV-файлы `hexaco_answers.csv` и `hexaco_results.csv`.
- По мере появления других тестов добавляем аналогичные экспортные утилиты.

## Безопасность и приватность
- Минимизируем PII: используем Telegram ID + хэшированные токены.
- Шифруем чувствительные поля в хранилище.
- Прописываем согласие пользователя на обработку данных перед запуском мэтчинга.
- Админская зона отделена по сети (VPN или allow-list), доступ аудируется.

## Планы по инфраструктуре
- Контейнеризация (Docker) для бота и backend-сервиса.
- CI для автопроверок линтеров/тестов при внесении новых тестов.
- Логи и метрики (структурированные события прохождения тестов, ошибки, метрики мэтчинга).
- При переходе на внешние БД или Google Sheets — отдельный воркер/коннектор, совместимый с текущей схемой.

