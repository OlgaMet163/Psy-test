# Техническая концепция

## Архитектура (факт)
- Telegram Bot API + aiogram 3, режим long polling.
- Локальная SQLite (`data/bot.db`) через `StorageGateway`; таблицы `hexaco_answers`, `hexaco_results`, `participant_emails`.
- Вся логика тестов в боте (handlers + services), хранилище состояний — `MemoryStorage` FSM.

## Обработка тестов
- Три теста: HEXACO (24), SVS (20), Hogan DSUSI-SF (38).
- Подсчёт: в сервисах `bot/services/*` (percent/mean, band, интерпретации).
- Блокировка параллельных тестов: старт проверяет текущее FSM-состояние.
- `/reset` очищает ответы и результаты пользователя из БД и сбрасывает FSM.

## Визуализация
- HEXACO, Hogan, SVS: PNG-радары на matplotlib (`bot/utils/plot.py`), отправляются при завершении теста и по запросу результатов. Ошибки логируются, текстовые результаты всегда отправляются. IM отображается только сотруднику.

## Меню и команды
- Только inline-клавиатура. Порядок: «Начать» → «Результаты» → «Перепройти» по каждому тесту (если есть результаты).
- Участник вводит почту; доступность «Результаты/Перепройти» определяется по сохранённой почте.
- Сотрудник: `teamswitch` → кнопка «Посмотреть участника» (ввод почты участника, регистронезависимо) → IM + базовые Hogan + блок «Кураторам». Возврат в меню — inline-кнопка.
- Параллельный запуск тестов блокируется FSM.

## Хранение и выгрузка
- Все ответы/результаты сохраняются в SQLite через `StorageGateway`; таблицы `hexaco_answers`/`hexaco_results` общие для всех тестов, `participant_emails` — маппинг почты на пользователя.
- Админский экспорт HEXACO: `python scripts/export_hexaco.py --output exports`.

## Безопасность и приватность
- Минимум PII: Telegram ID, без внешних идентификаторов.
- Пользователь может удалить свои данные `/reset`.

## Кодстайл
- Максимальная длина строки кода — 88 символов (black совместим).
- В IDE/Problems длина строки считается нарушением только при превышении 88
  символов; до 88 предупреждений быть не должно.

## Планы
- Перейти на вебхуки/контейнеризацию, вынести расчёты/мэтчинг в backend.
- Расширить экспорт/админ-зону и тестовое покрытие (pytest уже подключён).

